name: Backend ê°œë°œ ì„œë²„ CI/CD - ë¶€í•˜ í…ŒìŠ¤íŠ¸ìš©

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [ self-hosted, dev ]

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ìµœì‹  ì»¤ë°‹ ë‚´ì—­ìœ¼ë¡œ checkout í•œë‹¤
        uses: actions/checkout@v4

      - name: properties íŒŒì¼ì„ ê°±ì‹ í•œë‹¤
        env:
          APPLICATION_DEV_CLIENT_PROPERTIES: ${{ secrets.APPLICATION_DEV_CLIENT_PROPERTIES }}
          APPLICATION_DB_PROPERTIES: ${{ secrets.APPLICATION_DB_PROPERTIES }}
        run: |
          rm -rf src/main/resources/application-devclient.properties
          echo "$APPLICATION_DEV_CLIENT_PROPERTIES" > src/main/resources/application-devclient.properties
          rm -rf src/main/resources/application-db.properties
          echo "$APPLICATION_DB_PROPERTIES" > src/main/resources/application-db.properties

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í…ŒìŠ¤íŠ¸í•œë‹¤
        env:
          GRADLE_FAIL_REPORT_FOLDER: "build/reports/tests/test"
          S3_FAIL_REPORT_FOLDER: ${{ secrets.S3_BE_FAIL_REPORT_BUCKET }}
        run: |
          # í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì‹¤íŒ¨í•  ê²½ìš°, ë¦¬í¬íŠ¸ë¥¼ S3ì— ì—…ë¡œë“œí•˜ê³  ìž‘ì—…ì„ ì¢…ë£Œí•œë‹¤
          if ! ./gradlew test; then
            echo "ðŸ”´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            echo "=== S3ì— í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ ==="
            aws s3 cp $GRADLE_FAIL_REPORT_FOLDER $S3_FAIL_REPORT_FOLDER --recursive
            exit 1
          fi

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œ ë° ì‹¤í–‰í•œë‹¤
        env:
          LOGS_DIRECTORY: "/home/ubuntu/app-logs"
        run: |
          echo "=== JAR ë¹Œë“œ ==="
          ./gradlew --no-build-cache clean build -Dspring.profiles.active="dev,load-test"

          JAR_PATH=$(ls build/libs/*SNAPSHOT.jar | head -n 1)
          if [ ! -f "$JAR_PATH" ]; then
            echo "ë¹Œë“œëœ JAR íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $JAR_PATH"
            exit 1
          fi

          # ê¸°ì¡´ì— ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¨¼ì € ì¢…ë£Œí•œë‹¤
          echo "=== ì‹¤í–‰ ì¤‘ì¸ ì•± ì¢…ë£Œ ==="
          PID=$(pgrep -f "$JAR_PATH" || true)

          if [ -n "$PID" ]; then
            kill -15 $PID
            echo "â†’ ì¢…ë£Œ ì™„ë£Œ (PID: $PID)"
            sleep 5
          fi

          # ë¹Œë“œí•œ JAR íŒŒì¼ì„ ì‹¤í–‰ì‹œí‚¨ë‹¤
          echo "=== ì•± ì‹¤í–‰ ==="
          RUNNER_TRACKING_ID="" && nohup java -jar -Duser.timezone=Asia/Seoul -Dspring.profiles.active="dev,load-test" "$JAR_PATH" > "$LOGS_DIRECTORY/nohup.log" 2>&1 &
          sleep 3

          NEW_PID=$(pgrep -f "$JAR_PATH" || true)

          if [ -n "$NEW_PID" ]; then
            echo "ì•± ì‹¤í–‰ ì„±ê³µ (PID: $NEW_PID)"
          else
            echo "ì•± ì‹¤í–‰ ì‹¤íŒ¨"
            exit 1
          fi
